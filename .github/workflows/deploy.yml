name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: 99.79.49.194
          username: ec2-user
          key: |
            -----BEGIN RSA PRIVATE KEY-----
            MIIEowIBAAKCAQEAwV/D3CAyFd5knQnSTd7kE5BMDxdCSyu4QGePxzpcaE5LCp8X
            WI24j0oGcsmOTCL82htmCRVus6XUBEVibWhDatzhcJlwKlqvTnN3P2WLOJclEt86
            QIATCBufUm3tmZSCg0MJmSXpacQeflm/wCJk2pVakNqS4OnmWAsYqH0m6ni+MvH6
            8PPfhOboMbdAeAuwFtrgGZWWSz3LA1yvlJpkclq2TTM8pGgW5+0MKayrKLDYyzQf
            Bq6Fhop1w0QIPNrAhjzQPFiLiA0bEu2hJY65nOaooPv4jrzbm3WqW6wiFbNC3CqG
            RTMk/cYlh8yFgxLEVOx0Ai+Ls6nuqtMaIVMyFQIDAQABAoIBADuVqKJRgV1fs5z4
            A8de4ORuWCFmR1UmWZXu00zOXN7/EPxq3SS6Np5gbvA7zw8C0Orb+mreIchVVqki
            QBv6PpvVB9pMTVWfr9j6l0n/nhCH8jKIekiZrkOXT1Z07Puf2T9dDr4UAoJGnibM
            vNsVPgJkdw2fbBbFu+ZxNN3mAnHIzYIjgku4ra20JdpYHMJeIm/fZ/iZb2UAjGGN
            2C+AUFvP2JanDRAL0OPvVPt1l1yb0bb4YzOd8omDDE6prLn0iluRpMbYnec8d6zH
            D7BjIzPb/Te9G1+Jx/DYdFAB34/WKV9FJYvtnsjDRX0XIthZJn0g8B+p7jxFQMwk
            TdJhKQECgYEA6JVH5iOTQATGpGkMKEJgjduRW0MJ9LKfFU5s7MqFEN+S/nQl5Uyw
            OpRjPbscYsfKplDx/UETt5G7iIjyaBcuvmCINOLA53y73hY8YiLythjSOsQKukO8
            JH8BEOAPrCClUo0tSM1Rycy+tEyV+UDFnqV7gZNvgqKqzF0qrWUml/UCgYEA1Nfj
            yBcyNRWqoKZJ5gCkTaM9p7mmOkxUjpWLnZpvyqJrx3wozaF8xhgOCqNEdrKmrl91
            MV1Vj4QdX9txtMpBIxSxYeqzi8695OqoAucW/HRyU7N7/fYnSREKh1/Ln/J/SApz
            WraXaivBNVclNN68amQsGEdS6azuPBIc02KPfaECgYEA3ZiFhV61yBQE0taHT8BW
            UDI3nrUTwkGBUoKDQ2R9PaNWYPt2s67KZTXGDCW/GNp0WNvcg8fCKm8+NwsLsmMM
            FTTR8VluI9/y+tlCtNnJV/f0LStlcSxiEH+1G0fvhrcf7LQ3xhphZ5ycwhoJ9g5h
            exL9xmobn2KuysGljMlH6RUCgYAiiFh7mU/bDwXdBL3OpGID+q1BLjzLDqFVdOvv
            CSSEIvALsJhKLJ464aI9lZnBDGFAv1obRUJhg5TkfY0oQPxqfav97/9reoKSxoO1
            3Np84UO/UsqWPL7I+wvTRPabn9OI07E9kYxlfG3fgqEVv+Gf/VquIbxRD26jrmig
            30faoQKBgFJ1nSTdjHfs1wsllBQQBEUiBJcIRuXMhzeKuBYMgTUc2iVhxSl09SCD
            aLhzE0ABlZ/dAWoYovn6dFTwIrJuMlM8aBDrlMtFa0/twbBMNaKpOBQRU5TfCp+K
            bFVpx27r/F9rZGpK3dFStlsoviZv38uUvJ1CPPYZiZwNDj+zutcP
            -----END RSA PRIVATE KEY-----
          script: |
            cd /home/ec2-user/deepak-project-cc
            git pull origin main
            docker-compose down
            docker-compose up -d --build
            docker-compose ps

      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: 99.79.49.194
          username: ec2-user
          key: |
            -----BEGIN RSA PRIVATE KEY-----
            MIIEowIBAAKCAQEAwV/D3CAyFd5knQnSTd7kE5BMDxdCSyu4QGePxzpcaE5LCp8X
            WI24j0oGcsmOTCL82htmCRVus6XUBEVibWhDatzhcJlwKlqvTnN3P2WLOJclEt86
            QIATCBufUm3tmZSCg0MJmSXpacQeflm/wCJk2pVakNqS4OnmWAsYqH0m6ni+MvH6
            8PPfhOboMbdAeAuwFtrgGZWWSz3LA1yvlJpkclq2TTM8pGgW5+0MKayrKLDYyzQf
            Bq6Fhop1w0QIPNrAhjzQPFiLiA0bEu2hJY65nOaooPv4jrzbm3WqW6wiFbNC3CqG
            RTMk/cYlh8yFgxLEVOx0Ai+Ls6nuqtMaIVMyFQIDAQABAoIBADuVqKJRgV1fs5z4
            A8de4ORuWCFmR1UmWZXu00zOXN7/EPxq3SS6Np5gbvA7zw8C0Orb+mreIchVVqki
            QBv6PpvVB9pMTVWfr9j6l0n/nhCH8jKIekiZrkOXT1Z07Puf2T9dDr4UAoJGnibM
            vNsVPgJkdw2fbBbFu+ZxNN3mAnHIzYIjgku4ra20JdpYHMJeIm/fZ/iZb2UAjGGN
            2C+AUFvP2JanDRAL0OPvVPt1l1yb0bb4YzOd8omDDE6prLn0iluRpMbYnec8d6zH
            D7BjIzPb/Te9G1+Jx/DYdFAB34/WKV9FJYvtnsjDRX0XIthZJn0g8B+p7jxFQMwk
            TdJhKQECgYEA6JVH5iOTQATGpGkMKEJgjduRW0MJ9LKfFU5s7MqFEN+S/nQl5Uyw
            OpRjPbscYsfKplDx/UETt5G7iIjyaBcuvmCINOLA53y73hY8YiLythjSOsQKukO8
            JH8BEOAPrCClUo0tSM1Rycy+tEyV+UDFnqV7gZNvgqKqzF0qrWUml/UCgYEA1Nfj
            yBcyNRWqoKZJ5gCkTaM9p7mmOkxUjpWLnZpvyqJrx3wozaF8xhgOCqNEdrKmrl91
            MV1Vj4QdX9txtMpBIxSxYeqzi8695OqoAucW/HRyU7N7/fYnSREKh1/Ln/J/SApz
            WraXaivBNVclNN68amQsGEdS6azuPBIc02KPfaECgYEA3ZiFhV61yBQE0taHT8BW
            UDI3nrUTwkGBUoKDQ2R9PaNWYPt2s67KZTXGDCW/GNp0WNvcg8fCKm8+NwsLsmMM
            FTTR8VluI9/y+tlCtNnJV/f0LStlcSxiEH+1G0fvhrcf7LQ3xhphZ5ycwhoJ9g5h
            exL9xmobn2KuysGljMlH6RUCgYAiiFh7mU/bDwXdBL3OpGID+q1BLjzLDqFVdOvv
            CSSEIvALsJhKLJ464aI9lZnBDGFAv1obRUJhg5TkfY0oQPxqfav97/9reoKSxoO1
            3Np84UO/UsqWPL7I+wvTRPabn9OI07E9kYxlfG3fgqEVv+Gf/VquIbxRD26jrmig
            30faoQKBgFJ1nSTdjHfs1wsllBQQBEUiBJcIRuXMhzeKuBYMgTUc2iVhxSl09SCD
            aLhzE0ABlZ/dAWoYovn6dFTwIrJuMlM8aBDrlMtFa0/twbBMNaKpOBQRU5TfCp+K
            bFVpx27r/F9rZGpK3dFStlsoviZv38uUvJ1CPPYZiZwNDj+zutcP
            -----END RSA PRIVATE KEY-----
          script: |
            echo "Waiting for services to start..."
            sleep 15

            echo "Testing API Gateway..."
            curl -f http://localhost:8000/docs || exit 1

            echo "Deployment successful!"
            docker-compose ps

      - name: Notify Success
        if: success()
        run: echo " Deployment to EC2 completed successfully!"

      - name: Notify Failure
        if: failure()
        run: echo " Deployment failed. Check the logs above."